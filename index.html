<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Turbo Random Chat</title>
<style>
body{
margin:0;
background:#0d0d0f;
font-family:Arial;
color:white;
text-align:center;
}
header{
background:#1a1a1f;
padding:15px;
font-size:20px;
color:#bb86fc;
}
#onlineCount{
color:#03dac6;
font-size:14px;
}
video{
width:45%;
border-radius:12px;
background:black;
margin:10px;
}
button{
padding:12px 25px;
margin:8px;
border:none;
border-radius:8px;
background:#bb86fc;
color:black;
font-weight:bold;
cursor:pointer;
}
button:hover{
background:#9b5de5;
}
#chatBox{
width:90%;
height:120px;
margin:10px auto;
background:#1a1a1f;
border-radius:10px;
overflow:auto;
padding:10px;
font-size:14px;
text-align:left;
}
#messageInput{
width:70%;
padding:10px;
border-radius:6px;
border:none;
}
</style>
</head>
<body>

<header>
Turbo Random Video Chat
<div id="onlineCount">Online: 0</div>
</header>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<br>
<button onclick="start()">Start</button>
<button onclick="next()">Next</button>

<div id="chatBox"></div>
<input id="messageInput" placeholder="Type message...">
<button onclick="sendMessage()">Send</button>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>

var firebaseConfig = {
apiKey: "AIzaSyA3RrGjsEEzxLhFdnxlAfrfiSo0bcj9gB0",
authDomain: "video-9c617.firebaseapp.com",
databaseURL: "https://video-9c617-default-rtdb.firebaseio.com",
projectId: "video-9c617",
storageBucket: "video-9c617.firebasestorage.app",
messagingSenderId: "1018124902037",
appId: "1:1018124902037:web:e9bc3064bed86a82e8c59c"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();

let localStream;
let peer;
let myId = Math.random().toString(36).substr(2,9);
let currentRoom = null;

const servers = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

db.ref("online/"+myId).set(true);
db.ref("online/"+myId).onDisconnect().remove();

db.ref("online").on("value",snap=>{
document.getElementById("onlineCount").innerText="Online: "+snap.numChildren();
});

async function start(){

localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
document.getElementById("localVideo").srcObject = localStream;

db.ref("queue").once("value",async snap=>{
if(!snap.exists()){
db.ref("queue").set(myId);
}else{
let partnerId = snap.val();
currentRoom = "room_"+partnerId+"_"+myId;
db.ref("queue").remove();
createConnection(true,partnerId);
}
});
}

function createConnection(isCaller,partnerId){

peer = new RTCPeerConnection(servers);

localStream.getTracks().forEach(track=>{
peer.addTrack(track,localStream);
});

peer.ontrack = e=>{
document.getElementById("remoteVideo").srcObject = e.streams[0];
document.getElementById("notifSound").play();
};

peer.onicecandidate = e=>{
if(e.candidate){
db.ref("rooms/"+currentRoom+"/candidates").push(e.candidate.toJSON());
}
};

if(isCaller){
peer.createOffer().then(o=>{
peer.setLocalDescription(o);
db.ref("rooms/"+currentRoom+"/offer").set(o);
});
}

db.ref("rooms/"+currentRoom+"/offer").on("value",async snap=>{
if(snap.exists() && !isCaller){
await peer.setRemoteDescription(new RTCSessionDescription(snap.val()));
let answer = await peer.createAnswer();
await peer.setLocalDescription(answer);
db.ref("rooms/"+currentRoom+"/answer").set(answer);
}
});

db.ref("rooms/"+currentRoom+"/answer").on("value",async snap=>{
if(snap.exists()){
await peer.setRemoteDescription(new RTCSessionDescription(snap.val()));
}
});

db.ref("rooms/"+currentRoom+"/candidates").on("child_added",snap=>{
peer.addIceCandidate(new RTCIceCandidate(snap.val()));
});

db.ref("rooms/"+currentRoom+"/chat").on("child_added",snap=>{
let msg=snap.val();
document.getElementById("chatBox").innerHTML+="<div>"+msg+"</div>";
});
}

function sendMessage(){
let msg=document.getElementById("messageInput").value;
db.ref("rooms/"+currentRoom+"/chat").push("Stranger: "+msg);
document.getElementById("messageInput").value="";
}

function next(){
if(currentRoom){
db.ref("rooms/"+currentRoom).remove();
}
location.reload();
}

</script>

</body>
</html>
